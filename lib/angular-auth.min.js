!function(t,e){"use strict";e.module("ngAuth",[]).provider("Auth",function(){var o=this.config={logoutRedirect:"/",loginRedirect:"/",loginUrl:"/auth/login",signupUrl:"/auth/signup",signupRedirect:"/login",providers:{facebook:{url:"/auth/facebook",authorizationEndpoint:"https://www.facebook.com/dialog/oauth",redirectUri:t.location.origin,scope:"email",requiredUrlParams:["display"],display:"popup",protocol:"OAuth2"},google:{url:"/auth/google",authorizationEndpoint:"https://accounts.google.com/o/oauth2/auth",redirectUri:t.location.origin,scope:"openid profile email",requiredUrlParams:["scope"],optionalUrlParams:["display"],display:"popup",protocol:"OAuth2"},linkedin:{url:"/auth/linkedin",authorizationEndpoint:"https://www.linkedin.com/uas/oauth2/authorization",redirectUri:t.location.origin,requiredUrlParams:["state"],state:"STATE",protocol:"OAuth2"},twitter:{url:"/auth/twitter",authorizationEndpoint:"http://localhost:3000/auth/twitter",redirectUri:t.location.origin,protocol:"OAuth1"}}};return{setProvider:function(t){o.providers[t.name]=o.providers[t.name]||{},e.extend(o.providers[t.name],t)},$get:["$interval","$timeout","$http","$location","$rootScope","$alert","$q","$injector","$window",function(t,r,n,i,a,u,s,p,c){function l(t){var o=t.width||500,r=t.height||500;return e.extend({left:screen.width/2-o/2,top:screen.height/2-r/2,width:o,height:r},t)}function d(t){var e=[];for(var o in t)if(t.hasOwnProperty(o)){var r;switch(t[o]){case!0:r="1";break;case!1:r="0";break;default:r=t[o]}e.push(o+"="+r)}return e.join(",")}var h=c.localStorage.token;if(h){var f=JSON.parse(c.atob(h.split(".")[1]));a[o.userGlobal]=f.user}var g=function(t){this.popup=null,this.protocol=t};g.prototype.open=function(t,e,o){var r=s.defer(),n=d(l(o||{}));return this.popup=c.open(t,c.location.origin,n),this.popup.focus(),this.createPostMessageHandler(r),this.pollPopup(r),r.promise},g.prototype.pollPopup=function(e){var o=this;this.polling=t(function(){o.popup.closed&&(t.cancel(o.polling),e.reject("Popup was closed by the user."))},35)},g.prototype.createPostMessageHandler=function(t){c.addEventListener("message",function(e){if(e.origin===c.location.origin){var o=this.parseQueryString(e.data);t.resolve(o)}}.bind(this),!1)},g.prototype.parseQueryString=function(t){var o,r,n={};return e.forEach((t||"").split("&"),function(t){t&&(r=t.split("="),o=decodeURIComponent(r[0]),n[o]=e.isDefined(r[1])?decodeURIComponent(r[1]):!0)}),n},g.prototype.close=function(){this.popup&&(this.popup.close(),this.popup=null)};var v=function(t){e.extend(this,t),this.name=t.name,this.authorizationEndpoint=t.authorizationEndpoint};v.prototype.open=function(){var t=s.defer(),e=this.authorizationEndpoint,o=new g;return o.open(e).then(function(e){t.resolve(e.token)}),t.promise},v.createProvider=function(t){var e=o.providers[t],r=new v(e);return r};var m=function(t){e.extend(this,t),this.name=t.name,this.clientId=t.clientId,this.scope=t.scope,this.authorizationEndpoint=t.authorizationEndpoint,this.redirectUri=t.redirectUri,this.responseType="code",this.defaultUrlParams=["response_type","client_id","redirect_uri"],this.requiredUrlParams=t.requiredUrlParams,this.optionalUrlParams=t.optionalUrlParams};return m.prototype._camelCase=function(t){return t.replace(/([\:\-\_]+(.))/g,function(t,e,o,r){return r?o.toUpperCase():o})},m.prototype.open=function(){var t=s.defer(),e=this.buildUrl(),o=new g;return o.open(e).then(function(e){this._exchangeForToken(e.code).then(function(e){t.resolve(e.data)})}.bind(this)),t.promise},m.createProvider=function(t){var e=o.providers[t],r=new m(e);return r},m.prototype._exchangeForToken=function(t){var e={code:t,clientId:o.providers[this.name].clientId,redirectUri:o.providers[this.name].redirectUri};return console.log(e),n.post(this.url,e)},m.prototype.buildUrl=function(){var t=this.authorizationEndpoint,e=this.buildQueryString();return[t,e].join("?")},m.prototype.buildQueryString=function(){var t=this,o=[];return e.forEach(this.defaultUrlParams,function(e){var r=t._camelCase(e),n=t[r];o.push([e,encodeURIComponent(n)])}),e.forEach(this.requiredUrlParams,function(e){var r=t._camelCase(e),n=t[r];o.push([e,encodeURIComponent(n)])}),e.forEach(this.optionalUrlParams,function(e){var r=t._camelCase(e),n=t[r];o.push([e,encodeURIComponent(n)])}),o.map(function(t){return t.join("=")}).join("&")},{authenticate:function(t,e){var r;if(!t)return s.reject("Expected a provider named '"+t+"', did you forget to add it?");r="OAuth1"===o.providers[t].protocol?v.createProvider(t):m.createProvider(t);var n=s.defer();return r.open(e).then(function(t){var e=JSON.parse(c.atob(t.split(".")[1]));c.localStorage.token=t,a.currentUser=e.user,i.path(o.loginRedirect),n.resolve()}),n.promise},login:function(t){return n.post(o.loginUrl,t).success(function(t){c.localStorage.token=t.token;var e=JSON.parse(c.atob(t.token.split(".")[1]));a[o.userGlobal]=e.user,i.path(o.loginRedirect)})},signup:function(t){return n.post(o.signupUrl,t).success(function(){i.path(o.signupRedirect)})},logout:function(){delete c.localStorage.token,a[o.userGlobal]=null,i.path(o.logoutRedirect)},isAuthenticated:function(){return a[o.userGlobal]}}}]}}).factory("authInterceptor",["$q","$window","$location",function(t,e,o){return{request:function(t){return e.localStorage.token&&(t.headers.Authorization="Bearer "+e.localStorage.token),t},responseError:function(e){return(401===e.status||403===e.status)&&o.path("/login"),t.reject(e)}}}]).config(["$httpProvider",function(t){t.interceptors.push("authInterceptor")}]).run(["$rootScope","$window","$location",function(t,e,o){var r=e.location.search.substring(1);e.opener&&(r.indexOf("code")>-1||r.indexOf("token")>-1)&&(e.opener.postMessage(r,"*"),e.close()),t.$on("$routeChangeStart",function(e,r){!t.currentUser||"/login"!==r.originalPath&&"/signup"!==r.originalPath||o.path("/"),r.authenticated&&!t.currentUser&&o.path("/login")})}])}(window,window.angular);